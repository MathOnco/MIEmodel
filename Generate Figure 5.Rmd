---
title: "Generate Figure 5"
author: "Thomas Veith"
date: "01/02/2021"
output: html_document
---

Set correct root.dir for the project:
(Note that code expects output of "Generate Figures 2-4.Rmd" inside root.dir. In addition surrogate mis-segregation rates for the nine cancer type must be under input/Predicted_LaggingChrPct_TCGA.csv)
```{r setup}
knitr::opts_knit$set(root.dir = "path/to/dir")
```

Load libraries and define constants:
1) Libraries
2) N_SAMPLES: number of observations used in rlnorm() function below
3) MAXCHROMO: select crit curve based on maximum number of chromosomes in ploidy compartment
4) ALPHA and SHADECOLOR used for background segmentation in final output (2D Boxplot)
```{r}
library(ggplot2) 
library(gridExtra) 
library(matlab)
library(magrittr)
library(tidyverse)
N_SAMPLES=1000
MAXCHROMO=32
ALPHA=0.35
SHADECOLOR="gray"
```

Read predicted critical curves and plot one example:
```{r}
critcurves = read.csv(
  "expectedResults/all_critical_curves.csv",
  header = T,
  check.names = F,
  stringsAsFactors = F,
  strip.white = T
)
critcurves = critcurves[critcurves$maxchrom == MAXCHROMO,]
critcurves$departFromHomeostasis = 1 - critcurves$pop_avg_death_rate
critcurves$category = "Head and Neck"
new_critcurves = critcurves[critcurves$`B(i,beta)` == "B(i)==1/(beta+e^sqrt( abs( i-3 ) ))" &
                              critcurves$`D(i,mu)` == " D(i)==mu",]
old_critcurves = critcurves[critcurves$`B(i,beta)` == " B(i)==beta" &
                              critcurves$`D(i,mu)` == " D(i)==mu",]
tmp = old_critcurves[old_critcurves$pop_avg_death_rate < min(new_critcurves$pop_avg_death_rate),]
tmp$`B(i,beta)` = unique(new_critcurves$`B(i,beta)`)
tmp$pop_avg_misseg_rate = max(new_critcurves$pop_avg_misseg_rate)
new_critcurves = rbind(new_critcurves, tmp)
plot(
  new_critcurves$departFromHomeostasis,
  new_critcurves$pop_avg_misseg_rate,
  xlim = c(1E-3, 1),
  ylim = c(0, 1),
  log = "x",
  pch = 20
)

critList=list("consant"=old_critcurves, "varying"=new_critcurves)
```

Read/format data needed to produce 2D box plots of Chromosomal Mis-segregation
1) Read log medians & sdNorms for birth & growth rates into data frame 'birth_and_growth_Rates'
2) Create 'gRLN', 'bRLN' lists of log norm distributed growth rates and birth rates per cancer type
3) Set up 'dOVERb' data frame of death/birth where death=1-growth/birth, and replace negative entries with 0
4) Read 'inp' lagging chromosome data, remove metastases data, and normalize
5) Create 'subMap' mapping diseases in 'inp$group' to 'birth_and_growth_Rates$type', and set former to match latter
6) Add 1-death/birth to 'dOVERb' data frame
7) Choose whether to plot death/birth or 1-death/birth
8) Set x and y-labels for box plots
```{r}

birth_and_growth_Rates <-read.csv(
    "input/Log_means_and_sd_norms.csv",
    header = T,
    check.names = F,
    stringsAsFactors = F,
    strip.white = T
)

gRLN <-
  data.frame(
    sapply(birth_and_growth_Rates$type, function(x)
      rlnorm(N_SAMPLES, meanlog = birth_and_growth_Rates[birth_and_growth_Rates$type ==
                                                           x, ]$glm, sdlog = birth_and_growth_Rates[birth_and_growth_Rates$type == x, ]$gsd)),
    check.names = FALSE,
    fix.empty.names = FALSE
  )

bRLN <-
  data.frame(
    sapply(birth_and_growth_Rates$type, function(x)
      rlnorm(N_SAMPLES, meanlog = birth_and_growth_Rates[birth_and_growth_Rates$type ==
                                                           x, ]$blm, sdlog = birth_and_growth_Rates[birth_and_growth_Rates$type == x, ]$bsd)),
    check.names = FALSE,
    fix.empty.names = FALSE
  )

dOVERb <-
  data.frame(sapply(colnames(bRLN), function(x)
    (1 - (gRLN[, x] / bRLN[, x]))),
    check.names = FALSE,
    fix.empty.names = FALSE)
dOVERb[dOVERb < 0] <- 0
dOVERb <- tidyr::gather(dOVERb, key = "type", value = 'db')

inp <-
  read.table("input/Predicted_LaggingChrPct_TCGA.txt", header = T)
inp <- inp[inp$group != "met",]
inp$Lagging.Chromosome[inp$Lagging.Chromosome > 100] = 100
inp$Lagging.Chromosome <- inp$Lagging.Chromosome / 100

subMap = data.frame("inp" = sort(unique(inp$group)),
                    "type" = sort(unique(birth_and_growth_Rates$type)))

inp$group<-sapply(inp$group, function(x) inp[x, "group"]<-subMap[subMap$inp == x, "type"])

dOVERb$'one_minus_d_over_b'<-1-dOVERb$db

## choose whether you want to plot 1-d/b(T) or d/b(F)
adjVal<-T
if (adjVal==T) {
  xlab = expression(paste("Departure from Homeostasis (1-",mu,"/",lambda, ")"))
} else{
  xlab = expression(paste(mu,"/",lambda))
} 
ylab = expression(paste("Mis-segregation Rate (", beta, ")"))
```

Generate two separate box plots (one for each dimension):
1) Create box plot for x dimension using death/birth or 1-death/birth
2) Create box plot for y dimension using lagging chromosome data
3) Produce 2-panel figure for visual verification of box plots
4) "Layer the data" (i.e., take what we want from the box plots to construct our geom_rect() objects below)
5) Create 'df' data frame that will be used by ggplot for the 2D box plot
```{r}
if (adjVal==T) {
  plot.x <-
    ggplot(dOVERb) + geom_boxplot(aes(type, one_minus_d_over_b))  + coord_flip()
} else {
  plot.x <-
    ggplot(dOVERb) + geom_boxplot(aes(type, db))  + coord_flip()
}
plot.y <-
  ggplot(inp) + geom_boxplot(aes(group, Lagging.Chromosome))  + coord_flip()
grid.arrange(plot.x, plot.y, ncol = 2) # visual verification of the box plots

plot.x <- layer_data(plot.x)[, 1:6]
plot.y <- layer_data(plot.y)[, 1:6]
colnames(plot.x) <- paste0("x.", gsub("y", "", colnames(plot.x)))
colnames(plot.y) <- paste0("y.", gsub("y", "", colnames(plot.y)))

df <- cbind(plot.x, plot.y)
df$category <- sort(unique(dOVERb$type))
```

Load both box plots into same plot:
```{r}
plotList<-
    lapply(critList, function(q) ggplot(df, aes(fill = category, color = category)) +
    geom_line(
        data = q,
        aes(x = departFromHomeostasis, y = pop_avg_misseg_rate),
        size = 1,
        color = "black",
        linetype = "dotted"
    )  +
    
    ## 2D box defined by the Q1 & Q3 values in each dimension, with outline
    geom_rect(aes(
        xmin = x.lower,
        xmax = x.upper,
        ymin = y.lower,
        ymax = y.upper
    ),
    alpha = 0.3) +
    geom_rect(
        aes(
            xmin = x.lower,
            xmax = x.upper,
            ymin = y.lower,
            ymax = y.upper
        ),
        color = "black",
        fill = NA
    ) +
    
    ## whiskers for x-axis dimension with ends
    geom_segment(aes(
        x = x.min,
        y = y.middle,
        xend = x.max,
        yend = y.middle
    )) + ## whiskers
    geom_segment(aes(
        x = x.min,
        y = y.lower,
        xend = x.min,
        yend = y.upper
    )) + ## lower end
    geom_segment(aes(
        x = x.max,
        y = y.lower,
        xend = x.max,
        yend = y.upper
    )) + ## upper end
    
    ## whiskers for y-axis dimension with ends
    geom_segment(aes(
        x = x.middle,
        y = y.min,
        xend = x.middle,
        yend = y.max
    )) + ## whiskers
    geom_segment(aes(
        x = x.lower,
        y = y.min,
        xend = x.upper,
        yend = y.min
    )) + ## lower end
    geom_segment(aes(
        x = x.lower,
        y = y.max,
        xend = x.upper,
        yend = y.max
    )) + ## upper end
    
    ylab(ylab) + xlab(xlab)+
    scale_x_continuous(trans = "log", breaks=c(0, 0.002, 0.05, 1))  +
    theme_classic() +
    theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(colour = "black", size = 4)
    ) +
    
    ## shaded areas
    geom_ribbon(data=q,
                aes(x=departFromHomeostasis,y = pop_avg_misseg_rate,
                    ymin=pop_avg_misseg_rate,ymax=1),
                color = "gray",fill=SHADECOLOR,
                position="identity",alpha=ALPHA,linetype=2,) +
    
    ## shaded areas
    geom_ribbon(data=q,
                aes(x=departFromHomeostasis,y = pop_avg_misseg_rate,
                    ymin=max(pop_avg_misseg_rate),ymax=1),
                color = "black",fill="black",
                position="identity",alpha=0.2,linetype=2)      
)
pdf(paste0("figs/Figure_5.pdf"), width = 8.5,height = 11)
egg::ggarrange(plotList$consant, plotList$varying, labels = c("A", "B"))
plot(0, type = 'n', axes = FALSE, ann = FALSE)
legend("center",c("Not a steady state","Steady state leads to extinction","Steady state leads to exponential growth"),fill=c("black","gray","white"),cex=1.5)
dev.off()
```
Acknowledgement to https://stackoverflow.com/questions/46068074/double-box-plots-in-ggplot2